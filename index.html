<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Bank Manager Pro - Branch Edition</title>
  <style>
    :root { --bank-blue:#003366; --bg:#f0f2f5; --muted:#6c757d; --ok:#27ae60; --warn:#3498db; --violet:#9b59b6; --danger:#d63031; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif; background:var(--bg); margin:0; padding-bottom:200px; color:#111; }

    /* Nav Bar */
    .bottom-nav{ position:fixed; bottom:20px; left:5%; width:90%; background:#fff; display:flex; border-radius:15px; height:60px; z-index:1000; box-shadow:0 4px 15px rgba(0,0,0,0.2); border:1px solid #ddd; overflow:hidden; }
    .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:10px; color:#888; border:none; background:none; font-weight:900; }
    .nav-item.active { color: var(--bank-blue); background: #f8f9fa; }
    .nav-item i { font-style: normal; font-size: 18px; margin-bottom: 2px; }

    /* Layout */
    .page { display:none; padding:10px; animation: fadeIn 0.2s; }
    .page.active { display:block; }
    @keyframes fadeIn { from {opacity:0} to {opacity:1} }

    .card { background:#fff; border-radius:12px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:10px; border:1px solid #e9ecef; }
    .input-box { width:100%; border:1px solid #ccc; border-radius:8px; padding:10px; font-size:14px; margin-bottom:8px; outline:none; }
    
    .btn-add { background:var(--bank-blue); color:#fff; border:none; border-radius:10px; padding:12px; font-weight:900; width:100%; cursor:pointer; }
    .btn-ghost{ background:#eef2f7; color:#102a43; border:none; border-radius:10px; padding:10px; font-weight:900; width:100%; margin-top:5px; }
    .btn-action{ background:#495057; color:#fff; border:none; border-radius:6px; padding:5px 10px; font-size:11px; font-weight:bold; }

    /* Task Card - MATCHING ORIGINAL STYLE */
    .date-header { background:#dee2e6; padding:10px; font-weight:900; border-radius:10px; margin:15px 0 5px 0; display:flex; justify-content:space-between; align-items:center; border:1px solid #cfd4da; }
    .task-item { border-left:5px solid #ccc; padding:10px; margin:6px 0; background:#fff; border-radius:10px; border:1px solid #eee; }
    .status-completed { border-left-color: var(--ok); background:#f0fff4; }
    .status-processing { border-left-color: var(--warn); background:#f2f8ff; }
    .status-custpending { border-left-color: var(--violet); background:#faf5ff; }
    
    .task-name { font-size:14px; font-weight:900; color: var(--bank-blue); line-height:1.2; }
    .task-meta { font-size:11px; color:#555; margin:3px 0; font-weight: 600; }
    .rem-text { font-size:11px; color:#444; font-style:italic; border-top:1px dotted #ccc; margin-top:6px; padding-top:5px; white-space:pre-wrap; }
    .staff-badge { display:inline-block; background:#e1f5fe; color:#01579b; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:800; margin-bottom:4px; }

    .summary-box { background:#fff; border:1px solid #3498db; border-radius:10px; padding:10px; margin-bottom:10px; display:none; }
    .toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 15px; border-radius:20px; font-size:12px; display:none; z-index:3000; }
  </style>
</head>
<body>

  <div id="taskPage" class="page active">
    <div class="card" style="background:#fff9c4; border:1px solid #fbc02d;">
      <div style="display:flex; gap:5px;">
        <input type="date" id="globalDate" class="input-box" style="flex:1" />
        <select id="assignQuick" class="input-box" style="flex:1"></select>
      </div>
      <input type="text" id="manualTitle" class="input-box" placeholder="Customer Name" />
      <button class="btn-add" onclick="addManualTask()">+ QUICK ADD</button>
    </div>

    <div class="card">
      <input id="searchBox" class="input-box" placeholder="Search data..." oninput="renderTasks()" />
      <button class="btn-ghost" onclick="toggleSummary()">üìä TEAM SUMMARY & MASTER EMAIL</button>
      <div id="dailySummary" class="summary-box"></div>
    </div>

    <div id="taskContainer"></div>
  </div>

  <div id="parsePage" class="page">
    <div class="card" id="parserInputArea">
        <h3 style="margin:0 0 10px 0; color:var(--bank-blue)">Bulk Data Parser</h3>
        <select id="assignBulk" class="input-box"></select>
        <textarea id="rawInput" class="input-box" style="height:120px;" placeholder="ID Acc Name Phone Remarks / Next record..."></textarea>
        <button class="btn-add" onclick="bulkOrSingleParse()">PROCESS ENTRIES</button>
    </div>

    <div id="editArea" class="card" style="display:none;">
      <h3 style="margin:0 0 10px 0;">Edit Task</h3>
      <input type="hidden" id="editTaskId" />
      <select id="editAssignee" class="input-box"></select>
      <input type="text" id="editName" class="input-box" placeholder="Name" />
      <div style="display:flex; gap:5px;">
        <input type="text" id="editCustId" class="input-box" placeholder="ID" />
        <input type="text" id="editAcc" class="input-box" placeholder="Acc" />
      </div>
      <input type="text" id="editPhone" class="input-box" placeholder="Phone" />
      <select id="editStatus" class="input-box">
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="custpending">Cust-Pending</option>
        <option value="completed">Completed</option>
      </select>
      <textarea id="editRemarks" class="input-box" style="height:80px;" placeholder="Remarks"></textarea>
      <button class="btn-add" style="background:var(--ok)" onclick="commitTask()">SAVE CHANGES</button>
      <button class="btn-ghost" onclick="cancelEdit()">CANCEL</button>
    </div>
  </div>

  <div id="empPage" class="page">
    <div class="card">
        <h3>Staff Master</h3>
        <div style="display:flex; gap:5px;">
            <input type="text" id="newEmpName" class="input-box" placeholder="Staff Name" />
            <button class="btn-add" style="width:80px" onclick="addEmployee()">ADD</button>
        </div>
    </div>
    <div id="employeeList"></div>
    <br>
    <button class="btn-ghost" onclick="downloadBackup()">üíæ DOWNLOAD BACKUP (JSON)</button>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('taskPage', this)"><i>üìã</i>TASKS</button>
    <button class="nav-item" onclick="switchPage('parsePage', this)"><i>üîç</i>PARSER</button>
    <button class="nav-item" onclick="switchPage('empPage', this)"><i>üë•</i>STAFF</button>
  </nav>

  <div id="toast" class="toast"></div>

<script>
  let db = JSON.parse(localStorage.getItem('bank_tasks_v6')) || [];
  let emps = JSON.parse(localStorage.getItem('bank_emps_v6')) || [];

  function save() {
    localStorage.setItem('bank_tasks_v6', JSON.stringify(db));
    localStorage.setItem('bank_emps_v6', JSON.stringify(emps));
    updateDropdowns();
    renderTasks();
    renderEmployees();
  }

  function switchPage(p, el) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
    document.getElementById(p).classList.add('active');
    el.classList.add('active');
  }

  function updateDropdowns() {
    ['assignQuick', 'assignBulk', 'editAssignee'].forEach(id => {
        const el = document.getElementById(id);
        const val = el.value;
        el.innerHTML = '<option value="">Unassigned</option>' + emps.map(e => `<option value="${e}">${e}</option>`).join('');
        el.value = val;
    });
  }

  function addEmployee() {
    const n = document.getElementById('newEmpName').value.trim();
    if(n) { emps.push(n); document.getElementById('newEmpName').value=''; save(); }
  }

  function renderEmployees() {
    document.getElementById('employeeList').innerHTML = emps.map((e, i) => `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <b>${e}</b> <span onclick="deleteEmp(${i})" style="color:red; font-size:12px;">DELETE</span>
        </div>
    `).join('');
  }

  function deleteEmp(i) { if(confirm('Remove?')) { emps.splice(i,1); save(); } }

  function addManualTask() {
    const name = document.getElementById('manualTitle').value.trim();
    const date = document.getElementById('globalDate').value;
    const emp = document.getElementById('assignQuick').value;
    if(!name || !date) return alert("Missing Data");
    db.push({ uid: Date.now(), date, n:name, emp, status:'pending', id:'M', acc:'M', ph:'', rem:'' });
    document.getElementById('manualTitle').value = '';
    save();
  }

  // --- THE MASTER REPORT (EVERY DETAIL RETAINED) ---
  function emailDaySummary(date) {
    const tasks = db.filter(t => t.date === date);
    const order = { pending: 0, processing: 1, custpending: 2, completed: 3 };
    tasks.sort((a, b) => (order[a.status] ?? 9) - (order[b.status] ?? 9) || String(a.n).localeCompare(String(b.n)));

    let body = `--- MASTER BRANCH REPORT: ${date} ---\n\n`;
    tasks.forEach((t, i) => {
      body += `${i + 1}. [${(t.status || 'PENDING').toUpperCase()}] ${t.n || 'N/A'}\n`;
      body += `   STAFF   : ${t.emp || 'UNASSIGNED'}\n`;
      body += `   ID      : ${t.id || ''}\n`;
      body += `   A/C     : ${t.acc || ''}\n`;
      body += `   PHONE   : ${t.ph || ''}\n`;
      body += `   REMARKS : ${t.rem || 'None'}\n`;
      body += `------------------------------------\n`;
    });

    window.location.href = `mailto:?subject=Detailed Branch Report ${date}&body=${encodeURIComponent(body)}`;
  }

  function toggleSummary() {
    const box = document.getElementById('dailySummary');
    if (box.style.display === 'block') { box.style.display = 'none'; return; }
    
    const date = document.getElementById('globalDate').value;
    const tasks = db.filter(t => t.date === date);
    let html = `<b>Summary: ${date}</b><hr>`;

    emps.concat(['Unassigned']).forEach(name => {
        const tks = tasks.filter(t => (t.emp || 'Unassigned') === name);
        if(tks.length > 0) {
            html += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; align-items:center;">
                <span><b>${name}</b> (${tks.length})</span>
                <button class="btn-action" onclick="copyForEmployee('${name}', '${date}')">COPY FOR HIM</button>
            </div>`;
        }
    });

    html += `<button class="btn-add" style="margin-top:10px; background:#2c3e50" onclick="emailDaySummary('${date}')">üìß EMAIL MASTER REPORT (ALL DETAILS)</button>`;
    box.innerHTML = html; box.style.display = 'block';
  }

  function copyForEmployee(name, date) {
    const tasks = db.filter(t => t.date === date && (t.emp || 'Unassigned') === name);
    let text = `*STATUS REQUEST: ${name.toUpperCase()} (${date})*\n\n`;
    tasks.forEach((t, i) => {
        text += `${i+1}. ${t.n}\n   A/c: ${t.acc}\n   Status: ${t.status.toUpperCase()}\n   Rem: ${t.rem || 'Nil'}\n\n`;
    });
    text += `Please update current situation.`;
    navigator.clipboard.writeText(text).then(() => showToast("Copied for " + name));
  }

  // --- RENDER TASKS (MATCHING ORIGINAL STYLE) ---
  function renderTasks() {
    const cont = document.getElementById('taskContainer');
    const q = document.getElementById('searchBox').value.toLowerCase();
    cont.innerHTML = '';
    const grouped = {};
    db.forEach(t => { if(!q || JSON.stringify(t).toLowerCase().includes(q)) (grouped[t.date] = grouped[t.date] || []).push(t); });

    Object.keys(grouped).sort().reverse().forEach(date => {
        cont.innerHTML += `<div class="date-header">üìÖ ${date}</div>` + 
        grouped[date].map(t => `
            <div class="task-item status-${t.status}">
                <div class="staff-badge">üë§ ${t.emp || 'UNASSIGNED'}</div>
                <div class="task-name">${t.n}</div>
                <div class="task-meta">ID: ${t.id} | A/c: ${t.acc} | Ph: ${t.ph}</div>
                ${t.rem ? `<div class="rem-text">Rem: ${t.rem}</div>` : ''}
                <div style="margin-top:10px; display:flex; gap:15px; font-size:12px; font-weight:bold; color:var(--bank-blue);">
                    <span onclick="editTask(${t.uid})">‚úèÔ∏è EDIT</span>
                    <span onclick="deleteTask(${t.uid})" style="color:red">üóëÔ∏è DELETE</span>
                    ${t.ph ? `<span onclick="window.location.href='tel:${t.ph}'" style="color:green">üìû CALL</span>` : ''}
                </div>
            </div>
        `).join('');
    });
  }

  function bulkOrSingleParse() {
    const raw = document.getElementById('rawInput').value.trim();
    const date = document.getElementById('globalDate').value;
    const emp = document.getElementById('assignBulk').value;
    if(!raw || !date) return alert("Select Date");
    raw.split('/').forEach(r => {
        const w = r.trim().split(/\s+/);
        if(w.length > 2) {
            db.push({ uid: Date.now()+Math.random(), date, emp, status:'pending', id:w[0], acc:w[1], n:w[2], ph:'', rem:w.slice(3).join(' ') });
        }
    });
    document.getElementById('rawInput').value = ''; save();
    switchPage('taskPage', document.querySelectorAll('.nav-item')[0]);
  }

  function editTask(uid) {
    const t = db.find(x => x.uid == uid);
    document.getElementById('editTaskId').value = t.uid;
    document.getElementById('editName').value = t.n;
    document.getElementById('editCustId').value = t.id;
    document.getElementById('editAcc').value = t.acc;
    document.getElementById('editPhone').value = t.ph || "";
    document.getElementById('editAssignee').value = t.emp || "";
    document.getElementById('editStatus').value = t.status;
    document.getElementById('editRemarks').value = t.rem;
    document.getElementById('parserInputArea').style.display='none';
    document.getElementById('editArea').style.display='block';
    switchPage('parsePage', document.querySelectorAll('.nav-item')[1]);
  }

  function commitTask() {
    const idx = db.findIndex(x => x.uid == document.getElementById('editTaskId').value);
    db[idx].n = document.getElementById('editName').value;
    db[idx].id = document.getElementById('editCustId').value;
    db[idx].acc = document.getElementById('editAcc').value;
    db[idx].ph = document.getElementById('editPhone').value;
    db[idx].emp = document.getElementById('editAssignee').value;
    db[idx].status = document.getElementById('editStatus').value;
    db[idx].rem = document.getElementById('editRemarks').value;
    save(); cancelEdit(); switchPage('taskPage', document.querySelectorAll('.nav-item')[0]);
  }

  function deleteTask(uid) { if(confirm('Delete?')) { db = db.filter(x => x.uid != uid); save(); } }
  function cancelEdit() { document.getElementById('parserInputArea').style.display='block'; document.getElementById('editArea').style.display='none'; }
  function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display='none', 2000); }
  function downloadBackup() {
    const blob = new Blob([JSON.stringify({db, emps})], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'BranchBackup.json'; a.click();
  }

  document.getElementById('globalDate').value = new Date().toISOString().split('T')[0];
  save();
</script>
</body>
</html>
